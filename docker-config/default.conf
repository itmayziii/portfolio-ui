gzip on;
gzip_disable "msie6";
gzip_vary on;
gzip_proxied any;
gzip_comp_level 6;
gzip_buffers 16 8k;
gzip_http_version 1.1;
gzip_min_length 256;
gzip_types
  text/plain
  text/css
  application/json
  application/javascript
  application/x-javascript
  text/xml
  application/xml
  application/xml+rss
  text/javascript
  application/vnd.ms-fontobject
  application/x-font-ttf
  font/opentype
  image/svg+xml
  image/x-icon;

map $sent_http_content_type $cacheable_types {
  text/html no-cache; # HTML files are generated by our static site generator and we do not want browsers aggresively caching them
  text/css public;
  text/js public;
  application/javascript public;
  application/json public;
  ~image/ public;
  ~video/ public;
  default no-cache;
}

map $sent_http_content_type $expires {
  text/html off;
  default 1y;
}

server {
  listen 80;
  server_name fullheapdeveloper.com;

  # Redirect all requests for fullheapdeveloper.com to www.fullheapdeveloper.com
  location / {
    return 301 https://www.fullheapdeveloper.com$request_uri;
  }

  location /health {
    add_header Content-Type text/plain;
    return 200 'healthy';
  }
}

server {
  listen 80 default_server;
  server_name localhost *.fullheapdeveloper.com;
  root /usr/share/nginx/html;

  if ($http_x_forwarded_proto = "http") {
    return 301 https://$host$request_uri;
  }

  # Main location block as most traffic will go through here
  location / {
    # Remove trailing slashes
    rewrite ^/(.*)/$ /$1 permanent;

    add_header Cache-Control $cacheable_types;
    expires $expires;

    # Gatsby creates directories with index.html files in them, this allows us to resolve a URI without needing to specify index.html.
    try_files $uri $uri/index.html;
  }

  location /health {
    add_header Content-Type text/plain;
    return 200 'healthy';
  }
}
